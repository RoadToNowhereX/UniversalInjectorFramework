name: Build UniversalInjectorFramework

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    name: Build ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            platform: x64
          - arch: x86
            platform: Win32

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.1

    # 1. 编译 Detours
    - name: Build Detours
      run: |
        msbuild src/Detours/Detours.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.platform }} /p:OutDir="${{ github.workspace }}\Build\Detours\${{ matrix.platform }}\Release\\"

    # 2. 编译 ProxyGenerator
    - name: Build ProxyGenerator
      run: |
        msbuild src/ProxyGenerator/ProxyGenerator.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.platform }}

    # 3. Patch: 强制 Detours 引用使用 Release 配置
    - name: Patch Project Configuration
      shell: powershell
      run: |
        $path = "src/UniversalInjectorFramework/UniversalInjectorFramework.vcxproj"
        $content = Get-Content $path -Raw
        $guid = "{962a7719-2381-40d0-8214-377689f9429a}"
        if ($content -match $guid) {
            $replace = "<Project>$guid</Project><Properties>Configuration=Release</Properties>"
            $content = $content -replace [regex]::Escape("<Project>$guid</Project>"), $replace
            Set-Content $path $content
        }

    # 4. 编译 UIF (指定 SolutionDir)
    - name: Build UniversalInjectorFramework Proxies
      shell: powershell
      run: |
        $proxies = @("d3d8", "d3d9", "d3d11", "d3dcompiler_43", "d3dcompiler_47", "d3dx9_43", "dxgi", "iphlpapi", "opengl32", "version", "winmm")
        foreach ($proxy in $proxies) {
            Write-Host "Building $proxy for ${{ matrix.platform }}..."
            msbuild src/UniversalInjectorFramework/UniversalInjectorFramework.vcxproj `
                /p:Configuration=$proxy `
                /p:Platform=${{ matrix.platform }} `
                /p:SolutionDir="${{ github.workspace }}\src\\" `
                /t:Build
        }

    # 5. 收集产物 (修正路径)
    - name: Collect Artifacts
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "Artifacts\${{ matrix.arch }}"
        $sourceDir = "src\Build\UniversalInjectorFramework\${{ matrix.platform }}"
        if (Test-Path $sourceDir) {
            Get-ChildItem -Path "$sourceDir\*" -Include *.dll -Recurse | Copy-Item -Destination "Artifacts\${{ matrix.arch }}"
        } else {
            Write-Error "Directory not found: $sourceDir"
            exit 1
        }
        $pg = "Build\ProxyGenerator\${{ matrix.platform }}\Release\ProxyGenerator.exe"
        if (Test-Path $pg) { Copy-Item $pg "Artifacts\${{ matrix.arch }}" }

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: UniversalInjectorFramework-${{ matrix.arch }}
        path: Artifacts/${{ matrix.arch }}
