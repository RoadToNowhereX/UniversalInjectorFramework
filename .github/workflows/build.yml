name: Build UniversalInjectorFramework

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        platform: [Win32, x64]
        # 这里列出你想编译的 DLL 版本，根据 vcxproj 文件，可选值有：
        # d3d8, d3d9, d3d11, dxgi, opengl32, version, winmm, iphlpapi 等
        # 我们这里演示编译最常用的几个
        target_dll: [d3d8, d3d9, d3d11, d3dcompiler_43, d3dcompiler_47, d3dx9_43, dxgi, iphlpapi, opengl32, version, winmm]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Add MSBuild to PATH
      uses: microsoft/setup-msbuild@v1.3

    - name: Restore NuGet packages
      working-directory: src
      run: nuget restore UniversalInjectorFramework.sln

    # ----------------------------------------------------------------
    # 第一步：先编译 Detours 库
    # Detours 使用标准的 "Release" 配置，必须先单独编译好
    # ----------------------------------------------------------------
    - name: Build Detours (Dependency)
      working-directory: src
      run: msbuild Detours/Detours.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.platform }}

    # ----------------------------------------------------------------
    # 第二步：编译主项目
    # 1. Configuration 设置为具体的 DLL 名 (如 version)
    # 2. BuildProjectReferences=false 告诉它不要重新编译 Detours (防止配置名传参错误)
    # ----------------------------------------------------------------
    - name: Build Injector (${{ matrix.target_dll }})
      working-directory: src
      run: |
        msbuild UniversalInjectorFramework/UniversalInjectorFramework.vcxproj `
          /p:Configuration=${{ matrix.target_dll }} `
          /p:Platform=${{ matrix.platform }} `
          /p:BuildProjectReferences=false `
          /p:SolutionDir="${{ github.workspace }}\src\\"

    # ----------------------------------------------------------------
    # 上传产物
    # 根据 vcxproj 的 <OutDir>，生成目录在 Build 文件夹下
    # ----------------------------------------------------------------
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.target_dll }}-${{ matrix.platform }}
        path: |
          src/Build/UniversalInjectorFramework/${{ matrix.platform }}/**/*.dll
          src/Build/UniversalInjectorFramework/${{ matrix.platform }}/**/*.lib
          src/Build/UniversalInjectorFramework/${{ matrix.platform }}/**/*.pdb
